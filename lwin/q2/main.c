/*
 * OpenGL(GLFW) 애니메이션 예제
 * - 원 안에 7-segment 숫자 표시
 * - 삼각형 오브젝트 공전
 * - 키 입력 (→, ←)으로 공전 방향 전환
 */

#include <GLFW/glfw3.h>     // OpenGL과 창 관리를 위한 GLFW 라이브러리
#include <windows.h>        // GetAsyncKeyState 함수 사용 (윈도우 키보드 입력)
#include <math.h>           // 삼각함수 계산용 (cos, sin)

#pragma comment(lib, "opengl32.lib")  // OpenGL 라이브러리 링크 설정

#define PI 3.1415926535f    // 원주율 상수 (PI)

 // -------------------------------------------------------------
 // 7-segment 숫자 비트마스크 배열 (0~9)
 // 각 비트마스크는 세그먼트(a,b,c,d,e,f,g) ON/OFF 상태
 // -------------------------------------------------------------
const unsigned char SEGMENT_MAP[10] = {
    0b1111110,  // 0
    0b0110000,  // 1
    0b1101101,  // 2
    0b1111001,  // 3
    0b0110011,  // 4
    0b1011011,  // 5
    0b1011111,  // 6
    0b1110000,  // 7
    0b1111111,  // 8
    0b1111011   // 9
};

// -------------------------------------------------------------
// 화면에 직선을 그리는 함수
// (x1, y1): 시작점 좌표
// (x2, y2): 끝점 좌표
// -------------------------------------------------------------
void drawLine(float x1, float y1, float x2, float y2) {
    glBegin(GL_LINES);
    glVertex2f(x1, y1);
    glVertex2f(x2, y2);
    glEnd();
}

// -------------------------------------------------------------
// 7-segment 숫자 그리는 함수
// number: 출력할 숫자 (0~9)
// size: 숫자의 크기(세그먼트 전체 크기)
// -------------------------------------------------------------
void draw7Segment(int number, float size) {
    if (number < 0 || number > 9) return;  // 잘못된 입력 처리
    unsigned char seg = SEGMENT_MAP[number];  // 해당 숫자의 비트마스크 불러오기

    // 세그먼트 그릴 기준 좌표와 크기
    float x = -size / 2.0f;  // 왼쪽 기준점
    float y = size / 2.0f;   // 위쪽 기준점
    float w = size;          // 가로 길이
    float h = size / 5.0f;   // 선분 두께(적당히 작게)

    // 각 세그먼트를 비트마스크에 따라 그린다
    // a (상단 가로)
    if (seg & 0b1000000) drawLine(x, y, x + w, y);
    // b (우상 세로)
    if (seg & 0b0100000) drawLine(x + w, y, x + w, y - w / 2.0f);
    // c (우하 세로)
    if (seg & 0b0010000) drawLine(x + w, y - w / 2.0f, x + w, y - w);
    // d (하단 가로)
    if (seg & 0b0001000) drawLine(x, y - w, x + w, y - w);
    // e (좌하 세로)
    if (seg & 0b0000100) drawLine(x, y - w / 2.0f, x, y - w);
    // f (좌상 세로)
    if (seg & 0b0000010) drawLine(x, y, x, y - w / 2.0f);
    // g (중앙 가로)
    if (seg & 0b0000001) drawLine(x, y - w / 2.0f, x + w, y - w / 2.0f);
}

// -------------------------------------------------------------
// 삼각형 그리기 함수
// r: 삼각형 크기(반지름)
// -------------------------------------------------------------
void drawTriangle(float r) {
    glBegin(GL_TRIANGLES);
    for (int i = 0; i < 3; ++i) {
        float a = 2.0f * PI * i / 3;  // 각도 120도씩 분할
        glVertex2f(cosf(a) * r, sinf(a) * r);  // 꼭짓점 좌표 계산
    }
    glEnd();
}

// -------------------------------------------------------------
// 원 그리기 함수
// r: 원의 반지름
// seg: 원을 몇 등분으로 나눌지(부드럽게 그리기 위함)
// -------------------------------------------------------------
void drawCircle(float r, int seg) {
    glBegin(GL_TRIANGLE_FAN);
    glVertex2f(0.0f, 0.0f);  // 원의 중심점
    for (int i = 0; i <= seg; ++i) {
        float a = 2.0f * PI * i / seg;
        glVertex2f(cosf(a) * r, sinf(a) * r);
    }
    glEnd();
}

// -------------------------------------------------------------
// 메인 함수
// -------------------------------------------------------------
int main(void) {
    // GLFW 라이브러리 초기화
    if (!glfwInit()) return -1;

    // 800x600 크기의 창 생성
    GLFWwindow* window = glfwCreateWindow(800, 600, "Circle & Triangle Orbit + 7-Segment", NULL, NULL);
    if (!window) {
        glfwTerminate();
        return -1;
    }
    glfwMakeContextCurrent(window);  // OpenGL 컨텍스트 설정

    // 2D 직교 좌표계 설정 (-1 ~ 1)
    glOrtho(-1, 1, -1, 1, -1, 1);

    // -------------------------------------------------------------
    // 애니메이션 변수
    // time: 공전 각도 (계속 증가/감소)
    // timeDir: 공전 방향 (1: 시계방향, -1: 반시계방향)
    // -------------------------------------------------------------
    float time = 0.0f;
    int timeDir = 1;

    // -------------------------------------------------------------
    // 메인 루프
    // -------------------------------------------------------------
    while (!glfwWindowShouldClose(window)) {
        // -------------------------------------------------------------
        // 키 입력 처리 (GetAsyncKeyState 사용)
        // →키: 공전 방향 정방향
        // ←키: 공전 방향 역방향
        // -------------------------------------------------------------
        if (GetAsyncKeyState(VK_RIGHT) & 0x8000) {
            timeDir = 1;
        }
        if (GetAsyncKeyState(VK_LEFT) & 0x8000) {
            timeDir = -1;
        }

        // 공전 각도 업데이트
        time += 0.5f * timeDir;

        // -------------------------------------------------------------
        // 화면 초기화 (검정 배경)
        // -------------------------------------------------------------
        glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
        glClear(GL_COLOR_BUFFER_BIT);

        // -------------------------------------------------------------
        // 1) 중앙 원 그리기 (노란색)
        // -------------------------------------------------------------
        glPushMatrix();
        glColor3f(1.0f, 1.0f, 0.0f);  // 노란색
        drawCircle(0.3f, 60);         // 반지름 0.3, 60등분

        // -------------------------------------------------------------
        // 원 안에 7-segment 숫자 그리기
        // 숫자 1 출력, 색상 검정
        // -------------------------------------------------------------
        glColor3f(0.0f, 0.0f, 0.0f);  // 검정
        draw7Segment(1, 0.15f);       // 숫자 1, 크기 0.15
        glPopMatrix();                // 좌표계 복원

        // -------------------------------------------------------------
        // 2) 삼각형 공전
        // 중심을 기준으로 time 각도만큼 회전한 후, radius만큼 이동
        // -------------------------------------------------------------
        glPushMatrix();
        glRotatef(time, 0, 0, 1);        // 회전
        glTranslatef(0.6f, 0.0f, 0.0f);  // 중심에서 0.6 거리로 이동

        // 삼각형 색상: 하늘색
        glColor3f(0.0f, 1.0f, 1.0f);
        drawTriangle(0.1f);              // 반지름 0.1
        glPopMatrix();                   // 좌표계 복원

        // -------------------------------------------------------------
        // 화면 출력 (더블 버퍼)
        // -------------------------------------------------------------
        glfwSwapBuffers(window);
        glfwPollEvents();
    }

    // -------------------------------------------------------------
    // 프로그램 종료 처리
    // -------------------------------------------------------------
    glfwTerminate();
    return 0;
}
