#include <GLFW/glfw3.h>     // OpenGL과 창 관리를 위한 GLFW 라이브러리
#include <windows.h>        // GetAsyncKeyState 함수 사용 (윈도우 키보드 입력)
#include <math.h>           // 삼각함수 계산용 (cos, sin)

#pragma comment(lib, "opengl32.lib")  // OpenGL 라이브러리 링크 설정

#define PI 3.1415926535f    // 원주율 상수 (PI)

// -------------------------------------------------------------
// 별(육망성) 그리기 함수
// r: 별의 반지름
// 삼각형 두 개를 겹쳐서 꼭짓점이 6개인 육망성 형태로 별을 그린다
// -------------------------------------------------------------
void drawStar(float r) {
    // 정삼각형 높이 계산: r * sqrt(3) / 2
    float h = r * sqrtf(3.0f) / 2.0f;

    glBegin(GL_TRIANGLES);
    // 첫 번째 삼각형 (위쪽을 향하는 정삼각형)
    glVertex2f(0.0f, r);               // 꼭짓점 위
    glVertex2f(-h, -r / 2.0f);         // 왼쪽 아래
    glVertex2f(h, -r / 2.0f);          // 오른쪽 아래

    // 두 번째 삼각형 (아래쪽을 향하는 역삼각형)
    glVertex2f(0.0f, -r);              // 꼭짓점 아래
    glVertex2f(-h, r / 2.0f);          // 왼쪽 위
    glVertex2f(h, r / 2.0f);           // 오른쪽 위
    glEnd();
}

int main(void) {
    // -------------------------------------------------------------
    // 1) GLFW 라이브러리 초기화
    // -------------------------------------------------------------
    if (!glfwInit()) return -1;

    // -------------------------------------------------------------
    // 2) 800x600 크기의 창 생성
    // -------------------------------------------------------------
    GLFWwindow* window = glfwCreateWindow(800, 600, "Shooting Star Animation", NULL, NULL);
    if (!window) {
        glfwTerminate();
        return -1;
    }
    glfwMakeContextCurrent(window);  // OpenGL 컨텍스트 설정

    // -------------------------------------------------------------
    // 3) 2D 좌표계 설정 (-1 ~ 1 범위)
    // -------------------------------------------------------------
    glOrtho(-1, 1, -1, 1, -1, 1);

    // -------------------------------------------------------------
    // 4) 별 애니메이션 변수 초기화
    // -------------------------------------------------------------
    float starRadius = 0.05f;     // 별의 반지름 (0.05)
    float starX = 0.8f;           // 별의 초기 X 위치 (오른쪽 상단)
    float starY = 0.8f;           // 별의 초기 Y 위치 (오른쪽 상단)
    float speed = 0.01f;          // 별의 이동 속도
    float tailLength = 0.1f;      // 꼬리 길이 초기값

    // -------------------------------------------------------------
    // 5) 메인 루프
    // -------------------------------------------------------------
    while (!glfwWindowShouldClose(window)) {
        // -------------------------------------------------------------
        // (1) 키 입력 처리
        // 'S' 키가 눌렸는지 확인하여 꼬리 길이를 증가시킴
        // 최대 꼬리 길이를 0.5로 제한
        // -------------------------------------------------------------
        if (GetAsyncKeyState('S') & 0x8000) {
            tailLength += 0.01f;  // 꼬리 길이 증가
            if (tailLength > 0.5f) tailLength = 0.5f;  // 최대 길이 제한
        }

        // -------------------------------------------------------------
        // (2) 별 위치 업데이트
        // 별을 매 프레임마다 왼쪽 아래로 이동
        // 대각선 아래 방향으로 이동하도록 X와 Y를 동시에 감소
        // -------------------------------------------------------------
        starX -= speed;
        starY -= speed;

        // 별이 화면 밖으로 나가면 초기 위치로 리셋
        if (starX < -1.0f || starY < -1.0f) {
            starX = 0.8f;
            starY = 0.8f;
            tailLength = 0.1f;  // 꼬리 길이도 초기화
        }

        // -------------------------------------------------------------
        // (3) 화면 초기화
        // 검정색 배경으로 화면을 지움
        // -------------------------------------------------------------
        glClearColor(0.0f, 0.0f, 0.0f, 1.0f);  // 검정 배경
        glClear(GL_COLOR_BUFFER_BIT);

        // -------------------------------------------------------------
        // (4) 꼬리 그리기
        // glBegin(GL_LINES)를 사용해 선분으로 꼬리 표현
        // 현재 별 위치에서 tailLength 만큼 오른쪽 위로 선 그리기
        // -------------------------------------------------------------
        glColor3f(1.0f, 1.0f, 1.0f);           // 흰색
        glBegin(GL_LINES);
        glVertex2f(starX, starY);              // 꼬리 시작점 (별의 현재 위치)
        glVertex2f(starX + tailLength, starY + tailLength);  // 꼬리 끝점
        glEnd();

        // -------------------------------------------------------------
        // (5) 별 그리기
        // 별의 현재 위치로 이동한 후 drawStar() 호출
        // drawStar()에서 삼각형 두 개를 겹쳐 육망성 형태로 별을 그림
        // -------------------------------------------------------------
        glPushMatrix();                        // 현재 좌표계 저장
        glTranslatef(starX, starY, 0.0f);      // 별의 위치로 이동
        glColor3f(1.0f, 1.0f, 1.0f);           // 흰색
        drawStar(starRadius);                  // 육망성 별 그리기
        glPopMatrix();                         // 좌표계 복원

        // -------------------------------------------------------------
        // (6) 화면 출력
        // 더블 버퍼 교체 및 이벤트 처리
        // -------------------------------------------------------------
        glfwSwapBuffers(window);
        glfwPollEvents();
    }

    // -------------------------------------------------------------
    // 6) 프로그램 종료 처리
    // -------------------------------------------------------------
    glfwTerminate();
    return 0;
}
